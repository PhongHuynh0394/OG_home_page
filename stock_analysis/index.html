

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" />
    <title>Stock analysis - OG Page</title><meta name="Description" content="Stock Analysis using PCA and K-means"><meta property="og:title" content="Stock analysis" />
<meta property="og:description" content="Stock Analysis using PCA and K-means" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://phonghuynh.netlify.app/stock_analysis/" /><meta property="og:image" content="https://phonghuynh.netlify.app/img/projects-stock.jpg" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-31T14:39:53+07:00" />
<meta property="article:modified_time" content="2023-08-31T14:39:53+07:00" /><meta property="og:site_name" content="OG Page" />
<meta property="og:see_also" content="https://phonghuynh.netlify.app/stock_analysis_2/" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://phonghuynh.netlify.app/img/projects-stock.jpg"/>

<meta name="twitter:title" content="Stock analysis"/>
<meta name="twitter:description" content="Stock Analysis using PCA and K-means"/>
<meta name="application-name" content="OG">
<meta name="apple-mobile-web-app-title" content="OG">

<meta name="theme-color" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="https://phonghuynh.netlify.app/stock_analysis/" /><link rel="prev" href="https://phonghuynh.netlify.app/football_etl_2/" /><link rel="next" href="https://phonghuynh.netlify.app/stock_analysis_2/" />
<link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/color.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/fontawesome-free/all.min.css">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/animate/animate.min.css">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Stock analysis",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/phonghuynh.netlify.app\/stock_analysis\/"
        },"image": [{
                            "@type": "ImageObject",
                            "url": "https:\/\/phonghuynh.netlify.app\/avata.jpg",
                            "width":  960 ,
                            "height":  960 
                        }],"genre": "posts","keywords": "Machine learning, math","wordcount":  3829 ,
        "url": "https:\/\/phonghuynh.netlify.app\/stock_analysis\/","datePublished": "2023-08-31T14:39:53+07:00","dateModified": "2023-08-31T14:39:53+07:00","publisher": {
            "@type": "Organization",
            "name": "OG Page","logo": "https:\/\/phonghuynh.netlify.app\/favicon.icon"},"authors": [{
                        "@type": "Person",
                        "name": "OG"                    
                    }],"description": "Stock Analysis using PCA and K-means"
    }
    </script><script src="//instant.page/5.2.0" defer type="module" integrity="sha384-jnZyxPjiipYXnSU0ygqeac2q7CVYMbh84q0uHVRRxEtvFPiQYbXWUorga2aqZJ0z"></script>
</head>

<body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">
        function setTheme(theme) {document.body.setAttribute('theme', theme); document.documentElement.style.setProperty('color-scheme', theme === 'light' ? 'light' : 'dark'); window.theme = theme;   window.isDark = window.theme !== 'light' }
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {let theme = localStorage.getItem('theme');theme === 'light' || theme === 'dark' || theme === 'black' ? setTheme(theme) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light')); } else { if ('auto' === 'light' || 'auto' === 'dark' || 'auto' === 'black') setTheme('auto'), saveTheme('auto'); else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');}
        let metaColors = {'light': '#f8f8f8','dark': '#252627','black': '#000000'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
        window.switchThemeEventSet = new Set()
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="OG Page"><img
        class="logo"
        loading="lazy"
        src="/favicon.ico"
        srcset="/favicon.ico, /favicon.ico 1.5x, /favicon.ico 2x"
        sizes="auto"
        alt="/favicon.ico"
        title="/favicon.ico" >OG Page</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/blogs/" title="OG&#39;s blogs"> Blogs </a><a class="menu-item" href="/tags/" title="Tags of blogs"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/projects/"> Projects </a><a class="menu-item" href="/about/"> About </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="OG Page"><img
        class="logo"
        loading="lazy"
        src="/favicon.ico"
        srcset="/favicon.ico, /favicon.ico 1.5x, /favicon.ico 2x"
        sizes="auto"
        alt="/favicon.ico"
        title="/favicon.ico" >OG Page</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/blogs/" title="OG&#39;s blogs">Blogs</a><a class="menu-item" href="/tags/" title="Tags of blogs">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/projects/" title="">Projects</a><a class="menu-item" href="/about/" title="">About</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
            <div class="container"><div class="toc" id="toc-auto">
        <h2 class="toc-title">Contents</h2>
        <div class="toc-content always-active" id="toc-content-auto"><nav id="TableOfContents">
  <ul>
    <li><a href="#intro">Intro</a></li>
    <li><a href="#exploratory-data-analysis">Exploratory Data Analysis</a>
      <ul>
        <li><a href="#data-acquistion">Data Acquistion</a></li>
        <li><a href="#a-brief-view">A Brief View</a></li>
      </ul>
    </li>
    <li><a href="#data-preprocessing">Data Preprocessing</a>
      <ul>
        <li><a href="#data-cleaning">Data Cleaning</a></li>
        <li><a href="#data-transforming">Data transforming</a></li>
        <li><a href="#data-scaling">Data Scaling</a></li>
      </ul>
    </li>
    <li><a href="#principle-component-analysis-pca">Principle Component Analysis (PCA)</a>
      <ul>
        <li><a href="#eigenvector-và-eigenvalue">EigenVector và EigenValue</a></li>
        <li><a href="#cumulative-sum-of-components">Cumulative Sum of Components</a></li>
        <li><a href="#scree-chart">Scree Chart</a></li>
        <li><a href="#visualize-pca">Visualize PCA</a></li>
      </ul>
    </li>
    <li><a href="#to-be-continue">To be Continue</a></li>
  </ul>
</nav></div>
    </div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Stock analysis</h1><div class="post-meta">
            <div class="post-meta-line">
                <span class="post-author"><span class='author'><span class="author fas fa-user-circle fa-fw"></span><span class='screen-reader-text'>  </span><a href='https://phonghuynh.netlify.app/authors/og'>OG</a></span>
                </span>&nbsp;<span class="post-category">included in </span>&nbsp;<span class="post-category">category <a href="/categories/projects/"><i class="far fa-folder fa-fw"></i>projects</a></span>&nbsp;<span class="post-category">and</span>&nbsp;<span class="post-series">series <a href="/series/stock-analysis/"><i class="far fa-list-alt fa-fw"></i>Stock Analysis</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="31 Aug 2023">31 Aug 2023</time>&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;18 minutes&nbsp;</div>
        </div><div class="details series-nav open">
                                <div class="details-summary series-title">
                                    <span>Series - Stock Analysis</span>
                                    <span><i class="details-icon fas fa-angle-right"></i></span>
                                </div>
                                <div class="details-content series-content">
                                    <nav>
                                        <ul><li><span class="active">Stock analysis</span></li>
                                                    <li><a href="/stock_analysis_2/">Stock Analysis P2</a></li></ul>
                                    </nav>
                                </div>
                            </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#intro">Intro</a></li>
    <li><a href="#exploratory-data-analysis">Exploratory Data Analysis</a>
      <ul>
        <li><a href="#data-acquistion">Data Acquistion</a></li>
        <li><a href="#a-brief-view">A Brief View</a></li>
      </ul>
    </li>
    <li><a href="#data-preprocessing">Data Preprocessing</a>
      <ul>
        <li><a href="#data-cleaning">Data Cleaning</a></li>
        <li><a href="#data-transforming">Data transforming</a></li>
        <li><a href="#data-scaling">Data Scaling</a></li>
      </ul>
    </li>
    <li><a href="#principle-component-analysis-pca">Principle Component Analysis (PCA)</a>
      <ul>
        <li><a href="#eigenvector-và-eigenvalue">EigenVector và EigenValue</a></li>
        <li><a href="#cumulative-sum-of-components">Cumulative Sum of Components</a></li>
        <li><a href="#scree-chart">Scree Chart</a></li>
        <li><a href="#visualize-pca">Visualize PCA</a></li>
      </ul>
    </li>
    <li><a href="#to-be-continue">To be Continue</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><div class="details admonition warning open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-exclamation-triangle fa-fw"></i>Warning<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Đây là kiến thức tích góp từ nhiều nguồn và nghiên cứu của nhóm OG, tất nhiên không thể tránh khỏi sai sót.
Hy vọng bài viết lần này thú vị và giúp bạn đọc thư giãn, tham khảo.</div>
        </div>
    </div>
<p><strong>Source</strong>
<a target="_blank" href="https://github.com/PhongHuynh0394/Stock-Analysis" title="PhongHuynh0394" class="friend-link" rel="noopener noreferrer">
    <div class="friend-link-div">
        <div class="friend-link-avatar"><img
        
        loading="lazy"
        src="/img/github-logo.png"
        srcset="/img/github-logo.png, /img/github-logo.png 1.5x, /img/github-logo.png 2x"
        sizes="auto"
        alt="/img/github-logo.png"
        title="/img/github-logo.png" height="560"   width="560" ></div>
        <div class="friend-link-info">
            <div class="friend-name-div">
                <i class="fas fa-user-circle fa-fw"></i>
                <i class="friend-name">PhongHuynh0394</i>
            </div>
            <p class="friend-bio">Stock-Analysis</p>
        </div>
    </div>
</a></p>
<p>Hello! OG đây. Ở project lần này mình sẽ phân tích gia trị cổ phiếu phái sinh VN30 Index bằng cách sử dụng PCA và K-means. Xin vô cùng cảm ơn
sự đóng góp của 5 thành viên team OG và thầy Minh Mẫn và thầy Hoàng Đức đã tận tình hướng dẫn để team có thể hoàn thành đồ án một cách tốt nhất.</p>
<p>Rồi bây giờ gét gô thooiii 😄
<figure><a class="lightgallery" href="/img/projects-stock.jpg" title="Stock Analysis" data-thumbnail="/img/projects-stock.jpg">
        <img
            
            loading="lazy"
            src="/img/projects-stock.jpg"
            srcset="/img/projects-stock.jpg, /img/projects-stock.jpg 1.5x, /img/projects-stock.jpg 2x"
            sizes="auto"
            alt="Stock Analysis" height="533"  width="995" >
    </a></figure></p>
<h2 id="intro" class="headerLink">
    <a href="#intro" class="header-mark"></a>Intro</h2><p>Stock Analysis hay còn gọi là Market Analysis đề cập đến phương pháp mà nhà đầu tư hoặc nhà giao dịch sử dụng để đánh giá và điều tra một công cụ giao dịch cụ thể, lĩnh vực đầu tư hoặc toàn bộ thị trường chứng khoán.
Không những thế, nó liên quan đến việc nghiên cứu dữ liệu thị trường trong quá khứ và hiện tại và tạo ra một phương pháp để chọn cổ phiếu phù hợp để giao dịch. Các nhà đầu tư sẽ đưa ra quyết định mua hoặc bán dựa trên thông tin phân tích chứng khoán.</p>
<p>Trong project này ta sẽ phân tích, trực quan hóa bộ dữ liệu giả định được cung cấp bởi khách hàng để đánh giá thị trường chứng khoán
trong khoảng thời gian 1 tháng của 30 công ty thuộc VN30</p>
<p>Dưới đây là tóm tắt sơ lược từng bước để xử lý và phân tích:</p>
<ol>
<li>EDA (Exploratory Data Analysis)</li>
<li>Data Preprocessing</li>
<li>PCA (Principle Component Analysis)</li>
<li>K-Means Clustering</li>
<li>Data Analysis</li>
<li>References (chi tiết trong notebook ở github)</li>
</ol>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>Raw Data<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>Source: <a href="https://github.com/PhongHuynh0394/My-respository/blob/main/df_merged.pkl" target="_blank" rel="noopener noreferrer">df_merged.pkl</a></p>
<p>Raw data là dữ liệu bảng giá cổ phiếu của 30 công ty thuộc VN30 Index + 1 trường giá phái sinh trong 1 tháng</p>
</div>
        </div>
    </div>
<h2 id="exploratory-data-analysis" class="headerLink">
    <a href="#exploratory-data-analysis" class="header-mark"></a>Exploratory Data Analysis</h2><p>Đây là bước đầu tiên, chúng ta sẽ cùng nhau tìm hiểu sơ lược raw data cũng như tìm hiểu cái nhìn tổng quát về
dữ liệu ta sắp phải phân tích để từ đó có cách tiền xử lý phù hợp. Làm gì thì làm cứ phải import packages để đọc data cái đã</p>
<h3 id="data-acquistion" class="headerLink">
    <a href="#data-acquistion" class="header-mark"></a>Data Acquistion</h3><p>Ta sẽ import một số packages quen thuộc để đọc file <a href="https://github.com/PhongHuynh0394/My-respository/blob/main/df_merged.pkl" target="_blank" rel="noopener noreferrer">df_merged.pkl</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;https://github.com/PhongHuynh0394/My-respository/blob/main/df_merged.pkl?raw=true&#39;</span><span class="p">)</span>
<span class="c1"># Check the data type</span>
<span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="c1"># --&gt; list</span>
</code></pre></td></tr></table>
</div>
</div><p>Data nhận được từ pickle file là một list, bây giờ ta sẽ tìm kiếm cái nhìn tổng quan về dữ liệu này</p>
<h3 id="a-brief-view" class="headerLink">
    <a href="#a-brief-view" class="header-mark"></a>A Brief View</h3><ul>
<li>Dữ liệu lưu ở pickle là một list chứa 23 dataframe (df)</li>
<li>Mỗi df có index theo datetime (nghĩa là đây là loại dữ liệu thuộc timeseries)</li>
<li>Các columns lần lượt là từng mã cổ phiếu, chứa khối lượng/ giá của các lệnh mua/bán sát với lệnh khớp I và khối lượng của các lệnh mua/bán sát với giá khớp lệnh II</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;So luong df:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="c1"># --&gt; So luong df: 23</span>
</code></pre></td></tr></table>
</div>
</div><p><figure><a class="lightgallery" href="/img/stock-data.png" title="raw data" data-thumbnail="/img/stock-data.png" data-sub-html="<h2>Raw data là giá lệnh mua/bán I II và khối lượng giao dịch của cổ phiếu 30 công ty VN30</h2><p>raw data</p>">
        <img
            
            loading="lazy"
            src="/img/stock-data.png"
            srcset="/img/stock-data.png, /img/stock-data.png 1.5x, /img/stock-data.png 2x"
            sizes="auto"
            alt="raw data" height="823"  width="1227" >
    </a><figcaption class="image-caption">Raw data là giá lệnh mua/bán I II và khối lượng giao dịch của cổ phiếu 30 công ty VN30</figcaption>
    </figure></p>
<p>Thời gian thu thập được cập nhật với chu kì là 10 giây bắt đầu từ ngày 20 tháng 3 đến ngày 19 tháng 4, từ 2 giờ 15 đến 7 giờ 30 mỗi ngày. Nhưng có một số ngày bị miss trong bộ dữ liệu này (Chi tiết hơn trong notebook ở source code)</p>
<p>Cùng xem qua về số lượng observations của mỗi bảng
<figure><a class="lightgallery" href="/img/stock-view.png" title="dataframe shape" data-thumbnail="/img/stock-view.png">
        <img
            
            loading="lazy"
            src="/img/stock-view.png"
            srcset="/img/stock-view.png, /img/stock-view.png 1.5x, /img/stock-view.png 2x"
            sizes="auto"
            alt="dataframe shape" height="690"  width="1171" >
    </a></figure>
Tổng cộng ta có 181 fields và mỗi bảng khoảng 1345 observations (tổng cộng 30538 quan sát). Cũng khá nhiều phải không nào. Ta sẽ cùng tiền xử lý chúng nào</p>
<h2 id="data-preprocessing" class="headerLink">
    <a href="#data-preprocessing" class="header-mark"></a>Data Preprocessing</h2><p>Sau khi đã biết khái quát raw data, ta sẽ cần phải tiền xử lý những dữ liệu thô này trước khi có thể áp dụng các mô hình máy học hoặc giảm chiều dữ liệu</p>
<h3 id="data-cleaning" class="headerLink">
    <a href="#data-cleaning" class="header-mark"></a>Data Cleaning</h3><p>Hãy sử dụng method describe() của pandas để có cái nhìn sơ bộ nhất về df của chúng ta</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>Đầu tiên, ta sẽ drop duplicate và định dạng lại index thời gian</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">market</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span> <span class="c1">#create empty df</span>

<span class="c1"># Data cleaning</span>
<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
  <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

  <span class="n">cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

  <span class="c1">#convert/ replace 0</span>
  <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>

  <span class="c1"># #missing handling</span>
  <span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

  <span class="n">market</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">market</span><span class="p">,</span><span class="n">df</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1">#concat all clean df into market</span>

<span class="c1">#datetime format</span>
<span class="n">market</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">market</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;datetime&#39;</span><span class="p">})</span>
<span class="n">market</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">market</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
<span class="n">market</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">market</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">])</span>
<span class="n">market</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&#34;datetime&#34;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">market</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Kế tiếp hãy xử lý missing value bằng phương pháp nội suy (interpolation) với method <code>padding</code>, và sau đó sẽ dùng <code>backfill</code></p>
<p>Đây là phương pháp ước tính giá trị của các điểm dữ liệu chưa biết trong phạm vi của một tập hợp rời rạc chứa một số điểm dữ liệu đã biết.
Nghe có vẻ lằng nhằng, đơn giản là thế này:</p>
<ol>
<li><strong>.interpolate(method=&lsquo;pad&rsquo;)</strong>: fill null values bằng giá trị liền kề nó lần lượt từ trên xuống (nó giống như <code>ffill()</code>)</li>
<li><strong>.fillna(method=&lsquo;backfill&rsquo;)</strong>: Đây là phương pháp ngược lại bên trên, fill null bằng giá trị liền kề từ dưới lên</li>
</ol>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>Note<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>Có rất nhiều phương pháp nội suy như <code>linear</code> (default) hay <code>polynomial</code>,&hellip; Nhưng OG chọn padding và backfill vì
2 phương pháp này có thể giữ cho data missing ở giá trị sát nhất với giá trị thực gần nhất và giúp cho kết quả sau khi fill sát với thực tế nhất.</p>
<p>Ngoài ra 2 phương pháp này có thể fill được vị trí đầu và cuối cùng một cách hiệu quả.</p>
</div>
        </div>
    </div>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">handle_null</span><span class="p">(</span><span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
  <span class="s1">&#39;&#39;&#39;
</span><span class="s1">  handle missing value
</span><span class="s1">  &#39;&#39;&#39;</span>
  <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">():</span>
    <span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;pad&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;backfill&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
  <span class="k">return</span> <span class="n">X</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="data-transforming" class="headerLink">
    <a href="#data-transforming" class="header-mark"></a>Data transforming</h3><p>OG nhận thấy rằng với các trường data hiện tại chưa thực sự giúp ích quá nhiều trong việc phân tích sau này (giá mua/bán và số lượng mua/bán + giá phái sinh (<strong>label</strong>) )</p>
<p>Do đó OG cần một dataframe mới với các trường mới có nhiều giá trị phân tích hơn:</p>
<ul>
<li><strong>gttb_ (Giá trị trung bình)</strong>: là column mới được tính trên bình quân giá cả mua vào, bán ra của từng cổ phiếu được giao dịch THÀNH CÔNG trên thị trường.</li>
<li><strong>total_ban &amp; total_mua (Tổng bán/mua khối lượng 1)</strong>: là column mới để tính tổng giá bán khối lượng 1 cũng như mua khối lượng 1 của từng cố phiếu được giao dịch trên thị trường.</li>
<li><strong>Gia_KL</strong>: sao chép giá khối lượng của từng mã cổ phiếu từ bộ dữ liệu ban đầu. (<strong>label</strong>)</li>
<li><strong>Cài đặt lại index thời gian</strong>: group by các time-series theo phút.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">transform_raw</span><span class="p">(</span><span class="n">market</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
  <span class="c1"># split stock name</span>
  <span class="n">name</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_1&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">market</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;mua_gia_1&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]</span>
  <span class="n">new_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
    <span class="c1"># calculate gttb (mean)</span>
    <span class="n">new_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;gttb_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">market</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;mua_gia_1</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">market</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;mua_kl_1</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
                      <span class="o">+</span> <span class="n">market</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;ban_gia_1</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">market</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;ban_kl_1</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">])</span>
                      <span class="o">/</span><span class="p">(</span><span class="n">market</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;mua_kl_1</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">market</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;ban_kl_1</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="c1"># get ban_kl and mua_kl</span>
    <span class="n">new_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;total_ban_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">market</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;ban_kl_1</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">new_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;total_mua_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">market</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;mua_kl_1</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
  
  <span class="c1"># get Gia KL</span>
  <span class="n">new_df</span><span class="p">[</span><span class="s1">&#39;Gia KL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">market</span><span class="p">[</span><span class="s1">&#39;Gia KL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
  <span class="n">new_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">market</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


  <span class="n">gttb</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">new_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;gttb&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Gia KL&#39;</span><span class="p">]</span>
  <span class="n">mua_ban</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">new_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gttb</span><span class="p">]</span>

  <span class="c1"># Group by minute</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">new_df</span><span class="p">[</span><span class="n">gttb</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">new_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">new_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">new_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">minute</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">result</span><span class="p">,</span><span class="n">new_df</span><span class="p">[</span><span class="n">mua_ban</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">new_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> 
                                                      <span class="n">new_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span>
                                                      <span class="n">new_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">minute</span>
                                                      <span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
  
  <span class="c1">#Set index in minute</span>
  <span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">([</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2">:00&#34;</span> <span class="k">for</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">index</span><span class="p">])</span>
  <span class="n">result</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>

  <span class="c1">#handle missing value</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">handle_null</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">result</span>
</code></pre></td></tr></table>
</div>
</div><p>Rồi giờ transform rồi kiểm tra lại số lượng quan sát ở bảng mới thôi</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Check the length of new data</span>
<span class="nb">len</span><span class="p">(</span><span class="n">new_market</span><span class="p">)</span> <span class="c1"># --&gt; 5154</span>
</code></pre></td></tr></table>
</div>
</div><p>Với kết quả mới, chỉ còn lại 5154 quan sát mà thôi, khi rút lại một số lượng quan sát lớn như vậy, ta sẽ phải chấp nhận rủi ro mất
đi nhiều thông tin về dữ liệu mà cụ thể là dữ liệu theo giây (cứ 10 giây cập nhật). Nhưng đổi lại, data sẽ cô động hơn và bớt nhiễu vì
với sự biến đổi của thị trường trong cả 1 tháng, sự thay đổi của các trường trong mỗi 10 giây là quá nhỏ và không đáng kể.</p>
<h3 id="data-scaling" class="headerLink">
    <a href="#data-scaling" class="header-mark"></a>Data Scaling</h3><p>Sau khi có bộ dataframe mới tốt hơn và sạch sẽ, bước kế tiếp sẽ là scale lại dữ liệu về một chuẩn để tăng hiệu quả của các thuật toán học máy</p>
<p>Có một số phương pháp scale data như: Standardization, Normalization,&hellip;</p>
<p>Ở project này, OG sẽ dùng phương pháp <strong>Normalization</strong> để scale data. Phương pháp chuẩn hóa này đưa tỷ lệ dữ liệu từ phạm vi ban đầu
về chuẩn phạm vi từ 0 đến 1, giá trị được normalize theo công thức sau:</p>
<p>$$ x' = \frac{x - min}{max - min} $$
Với $x$ là giá trị cần được chuẩn hóa, $max$ và $min$ là lần lượt là giá trị lớn nhất và nhỏ nhất trong tất cả các observations của feature trong tập dữ liệu.</p>
<p>Ta sẽ dùng <code>MinMaxScaler</code> của <code>scikit-learn</code> trong tác vụ này.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span>

<span class="c1"># Normalization data using libraries</span>
<span class="n">min_max</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">new_market</span><span class="o">.</span><span class="n">values</span>
<span class="n">X_std</span> <span class="o">=</span> <span class="n">min_max</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data after scaling: &#39;</span><span class="p">)</span>
<span class="n">X_std</span>
<span class="c1"># array([[9.10048201e-01, 9.43990665e-01, 9.59215952e-01, ...,</span>
<span class="c1">#         1.31664615e-02, 1.45711006e-02, 2.90267046e-03],</span>
<span class="c1">#        [9.14492108e-01, 9.61493582e-01, 9.57989455e-01, ...,</span>
<span class="c1">#         1.42007963e-02, 1.10109072e-04, 3.64335188e-03],</span>
<span class="c1">#        [9.12286536e-01, 9.57992999e-01, 9.56950233e-01, ...,</span>
<span class="c1">#         3.58702686e-03, 1.43141794e-03, 4.40405173e-04],</span>
<span class="c1">#        ...,</span>
<span class="c1">#        [9.23665190e-01, 9.04317386e-01, 8.96622210e-01, ...,</span>
<span class="c1">#         1.22024151e-01, 3.04635100e-03, 2.10293470e-02],</span>
<span class="c1">#        [9.24218272e-01, 8.89565349e-01, 8.97159958e-01, ...,</span>
<span class="c1">#         1.05691866e-02, 1.13779375e-03, 2.88265204e-02],</span>
<span class="c1">#        [9.28532923e-01, 9.04317386e-01, 8.98196897e-01, ...,</span>
<span class="c1">#         8.84087818e-03, 3.67030241e-04, 7.79383700e-03]]</span>
</code></pre></td></tr></table>
</div>
</div><p>Như vậy là đã chuẩn bị hoàn tất cho bước tiếp theo rồi. Chúng ta sẽ bước vào thuật toán chính đầu tiên trong project này.</p>
<h2 id="principle-component-analysis-pca" class="headerLink">
    <a href="#principle-component-analysis-pca" class="header-mark"></a>Principle Component Analysis (PCA)</h2><p>Chúng ta đã đi qua việc tiền xử lý dài ngoằn từ cleaning, transforming đến scaling. Vậy câu hỏi là: <strong>dữ liệu đã sẵn sàng để
áp dụng cho các mô hình máy học hay chưa ?</strong></p>
<p>Câu trả lời cho trường hợp này là: <strong>Chưa</strong>. Tại sao vậy ? Bởi vì tập dữ liệu của chúng ta có quá nhiều features</p>
<div class="details admonition note">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>Feature của tập data là gì ?<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Dành cho bạn chưa biết, feature của tập data còn được gọi là các trường (hay field) của tập data đó. Đó là các cột, mỗi cột là một &ldquo;tính chất&rdquo; khác nhau của đối tượng aka quan sát (observation) thường là các hàng.</div>
        </div>
    </div>
<p>Hiện tại có thể thấy cleaning data của chúng ta có 91 features:</p>
<ul>
<li><strong>gttb_(cổ phiếu)</strong>: 30 cột giá trị trung bình giao dịch của 30 cổ phiếu trong 1 phút</li>
<li><strong>total_ban_(cổ phiếu)</strong>: 30 cột tổng khối lượng bán của 30 cổ phiếu trong 1 phút</li>
<li><strong>total_mua_(cổ phiếu)</strong>: 30 cột tổng khối lượng mua của 30 cổ phiếu trong 1 phút</li>
<li><strong>Gia_KL</strong>: 1 cột giá phái sinh VN30 Index (label)</li>
</ul>
<p>Với số lượng feature lớn như vậy, sẽ vô cùng kém hiệu quả nếu ngay lập tức sử dụng train cho các mô hình machine learning. Giải pháp ở đây
chính là ta sẽ giảm chiều dữ liệu xuống mức vừa đạt hiệu năng tốt khi training mà cũng không làm mất quá nhiều thông tin của dữ liệu.</p>
<p>Vâng đúng vậy, phương pháp OG muốn giới thiệu chính là <code>PCA</code> hay còn được biết với tên việt hóa là <code>Phân tích thành phần chính</code>. Mục tiêu của phương pháp này
là đưa bộ dữ liệu ban đầu sang hệ tọa độ mới dựa trên các thành phần chính. Dữ liệu ở hệ tọa độ mới có ít chiều hơn nhưng vẫn giữ được nhiều nhất thông tin có thể,
từ đó giúp tăng tốc độ tính toán và giảm độ phức tạp mô hình hơn rất nhiều.</p>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>Nói tóm tắt cho dễ hiểu<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Cơ bản là phương pháp này đưa bộ data của ta vào một &ldquo;thế giới song song&rdquo; có số chiều mới ít hơn (chiều aka features). Bạn có thể hiểu như là nhìn dữ liệu của mình ở một góc khác vậy.</div>
        </div>
    </div>
<p>Ở phần này chúng ta sẽ sử dụng phương pháp này thông qua sự phân rã của ma trận hiệp phương sai (Eigen decomposition of covariance matrix)</p>
<h3 id="eigenvector-và-eigenvalue" class="headerLink">
    <a href="#eigenvector-v%c3%a0-eigenvalue" class="header-mark"></a>EigenVector và EigenValue</h3><p>Ma trận hiệp phương sai được định nghĩa là:</p>
<p>$$ S = \frac{1}{N}\hat{X}^T\hat{X} $$</p>
<p>Với $\hat{X} = X - \hat{x}1^T$ là zero-corrected data hay dữ liệu đã được chuẩn hoá.</p>
<p>Ta sẽ viết hàm <strong>get_eigenpairs()</strong> để tìm các vector riêng và giá trị riêng của ma trận hiệp phương sai:</p>
<p>$$ Su_i = \lambda_iu_i $$</p>
<p>Trong đó: các $(\lambda_i,u_i)$ là các cặp trị riêng (không âm) và vector riêng của ma trận hiệp phương sai $S$</p>
<p><strong>Tại sao lại cần tìm các vector riêng và giá trị riêng của ma trận hiệp phương sai ?</strong>
Việc sử dụng các giá trị riêng để đánh giá sự quan trọng của mỗi thành phần chính được tạo ra từ việc giảm chiều dữ liệu.
Các giá trị riêng càng lớn thì thành phần chính tương ứng càng quan trọng.
Các vector riêng tương ứng với các giá trị riêng này được sử dụng để xác định hướng của các thành phần chính.</p>
<ul>
<li><strong>Giá trị riêng (Eigenvalues $\lambda_i$)</strong>: Các hệ số được gắn với các vector riêng, cung cấp cho độ lớn của trục. Trong trường hợp này, chúng là thước đo hiệp phương sai của dữ liệu.</li>
<li><strong>Vector riêng (EigenVector $u_i$)</strong>:Các vector (khác 0) không thay đổi hướng khi áp dụng bất kỳ phép biến đổi tuyến tính (linear transformation) nào, nó chỉ thay đổi theo hệ số vô hướng.</li>
<li><strong>Hàm sắp xếp các vector riêng (Sort eigenvalues)</strong>: Bằng cách sắp xếp các vector riêng theo thứ tự của giá trị riêng, ta có thể chọn ra các vector riêng có giá trị riêng lớn nhất để xây dựng các thành phần chính của dữ liệu (đóng góp nhiều nhất vào việc giải thích sự biến thiên của dữ liệu). Các thành phần chính này có thể được sử dụng để tái cấu trúc dữ liệu ban đầu mà vẫn giữ được độ giống nhau của các điểm dữ liệu ban đầu.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">get_eigenpairs</span><span class="p">(</span><span class="n">X</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
  <span class="s1">&#39;&#39;&#39;
</span><span class="s1">  Input: X: np.array (init matrix)
</span><span class="s1">  return eigenpairs containing eigenvalues and eigenvectors of covariance matrix
</span><span class="s1">  &#39;&#39;&#39;</span>
  <span class="c1"># Covariance matrix</span>
  <span class="n">cov_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

  <span class="c1"># Eigenvalues and Eigenvectors</span>
  <span class="n">evals</span><span class="p">,</span> <span class="n">evecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)</span>

  <span class="c1"># Sort eigenvalues</span>
  <span class="n">epairs</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">eval</span><span class="p">),</span> <span class="n">evec</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="nb">eval</span><span class="p">,</span> <span class="n">evec</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">evals</span><span class="p">,</span> <span class="n">evecs</span><span class="o">.</span><span class="n">T</span><span class="p">)]</span>
  <span class="n">epairs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">epairs</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">pair</span><span class="p">:</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">epairs</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="cumulative-sum-of-components" class="headerLink">
    <a href="#cumulative-sum-of-components" class="header-mark"></a>Cumulative Sum of Components</h3><p>Tính tổng tích lũy của các thành phần trong PCA (Cumulative Sum of Explained Variance) để xác định tổng phần trăm phương sai được giải thích bởi các thành phần được giữ lại trong mô hình PCA.
$$ r_K = \frac{\sum^K_{i=1}\lambda_i}{\sum^D_{j=1}\lambda_j} $$
là lượng thông tin được giữ lại khi số chiều dữ liệu mới sau PCA là K.</p>
<ul>
<li>Hàm findNumVec() thực hiện việc lấy các giá trị riêng từ danh sách các eigenpairs và chuyển đổi chúng thành một mảng numpy. Sau đó, nó tính tổng tích lũy của các giá trị riêng, sử dụng hàm np.cumsum () chuẩn hóa tổng của chúng =&gt; cho ra một danh sách các giá trị (trong khoảng từ 0 đến 1) đại diện cho tỷ lệ phần trăm phương sai được giải thích bởi mỗi thành phần chính.</li>
<li>Sau đó, hàm lặp qua danh sách tổng tích lũy và tìm chỉ mục của giá trị đầu tiên lớn hơn hoặc bằng tỷ lệ phần trăm phương sai mong muốn được giải thích. Chỉ số này đại diện cho số lượng thành phần chính cần thiết để giải thích tỷ lệ phần trăm phương sai đó, vì vậy hàm trả về giá trị này cộng với 1 (vì lập chỉ mục Python bắt đầu từ 0).</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">findNumVec</span><span class="p">(</span><span class="n">eigenpairs</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">percent</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">):</span>
    <span class="s1">&#39;&#39;&#39;
</span><span class="s1">    Find number of principal components (eigenvectors) 
</span><span class="s1">    -&gt; return the number of principal components when total accumulate &gt;= percent
</span><span class="s1">    &#39;&#39;&#39;</span>

    <span class="c1"># Get eigenvalues </span>
    <span class="n">eigenvals</span> <span class="o">=</span> <span class="p">[</span><span class="n">eigenval</span> <span class="k">for</span> <span class="p">(</span><span class="n">eigenval</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">eigenpairs</span><span class="p">]</span>
    <span class="n">eigenvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">eigenvals</span><span class="p">)</span>
    
    <span class="c1"># Cumulative sum and calculate percent</span>
    <span class="n">cumsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">eigenvals</span><span class="p">)</span>
    <span class="n">cumsum</span> <span class="o">/=</span> <span class="n">cumsum</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Find number of principal components that accumulate &gt;= percent</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cumsum</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;=</span> <span class="n">percent</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
</code></pre></td></tr></table>
</div>
</div><p>Ta sẽ thử tìm xem số thành phần chính cần để giữ được 80% dữ liệu:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="nb">print</span><span class="p">(</span><span class="n">findNumVec</span><span class="p">(</span><span class="n">epairs</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">))</span> <span class="c1"># --&gt; 28</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="scree-chart" class="headerLink">
    <a href="#scree-chart" class="header-mark"></a>Scree Chart</h3><p>Ta sẽ vẽ một biểu đồ thể hiện quan hệ của số lượng thành phần chính và phần trăm phương sai giải thích tích lũy</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">screeplot</span><span class="p">(</span><span class="n">eigenpairs</span><span class="p">):</span>
    <span class="s1">&#39;&#39;&#39;
</span><span class="s1">    Scree plot
</span><span class="s1">    &#39;&#39;&#39;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">eigenvals</span> <span class="o">=</span> <span class="p">[</span><span class="n">eigenval</span> <span class="k">for</span> <span class="p">(</span><span class="n">eigenval</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">eigenpairs</span><span class="p">]</span>
    <span class="n">eigenvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">eigenvals</span><span class="p">)</span>
    <span class="n">cumsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">eigenvals</span><span class="p">)</span> <span class="c1"># extracts the eigenvalues from the eigenpairs and calculates their cumulative sum</span>
    <span class="n">cumsum</span> <span class="o">/=</span> <span class="n">cumsum</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">name</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PCA </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cumsum</span><span class="p">))]</span>

    <span class="c1"># line plot</span>
    <span class="c1"># the eigenvalues are plotted against the number of principal components</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eigenvals</span><span class="p">)),</span> <span class="n">eigenvals</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Eigenvalue&#39;</span><span class="p">)</span> 
    
    <span class="c1"># the cumulative proportion of the variance explained by each component is plotted against the number of principal components</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cumsum</span><span class="p">)),</span> <span class="n">cumsum</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Cumulative propotion&#39;</span><span class="p">)</span>
    
    <span class="c1"># y axis label</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Eigen values&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative explained variance&#39;</span><span class="p">)</span>

    <span class="c1"># item legend</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="c1"># grid</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

    <span class="c1"># title</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">supxlabel</span><span class="p">(</span><span class="s1">&#39;Number of components&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1">#print the cumsum of eigenvalues</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cumsum</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Cumulative total&#39;</span><span class="p">],</span> <span class="n">index</span> <span class="o">=</span> <span class="n">name</span><span class="p">))</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">):</span> <span class="sa">f</span><span class="s2">&#34;PC </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">var</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&#34;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cumsum</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">result</span>
<span class="n">pca_scree</span> <span class="o">=</span> <span class="n">screeplot</span><span class="p">(</span><span class="n">epairs</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p><figure><a class="lightgallery" href="/img/stock-scree.png" title="Scree plot" data-thumbnail="/img/stock-scree.png" data-sub-html="<h2>Scree plot</h2><p>Scree plot</p>">
        <img
            
            loading="lazy"
            src="/img/stock-scree.png"
            srcset="/img/stock-scree.png, /img/stock-scree.png 1.5x, /img/stock-scree.png 2x"
            sizes="auto"
            alt="Scree plot" height="726"  width="667" >
    </a><figcaption class="image-caption">Scree plot</figcaption>
    </figure></p>
<p><div class="details admonition example">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-list-ol fa-fw"></i>Giải thích<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>Đường của giá trị riêng màu xanh nước biển trên biểu đồ cho ta biết độ lớn của mỗi thành phần chính và tầm quan trọng của chúng trong giải thích sự biến thiên của dữ liệu.
Nếu giá trị riêng của một thành phần chính là lớn, thì thành phần đó có tầm quan trọng cao trong việc giải thích sự biến thiên của dữ liệu.</p>
<p>Đường màu xanh lá thể hiện tổng tích lũy cho ta biết tổng phần trăm độ lớn của sự biến thiên của dữ liệu mà các thành phần chính có thể giải thích.</p>
</div>
        </div>
    </div>
Dựa vào biểu đồ trên có thể nhận thấy nếu chỉ có 2 chiều, ta chỉ giữ được khoảng 37% dữ liệu ban đầu.</p>
<h3 id="visualize-pca" class="headerLink">
    <a href="#visualize-pca" class="header-mark"></a>Visualize PCA</h3><p>Bây giờ, ta sẽ thực hiện chiếu dữ liệu ban đầu đã chuẩn hóa $\hat{X}$ xuống không gian con tìm được và lấy ra ma trận các thành phần chính để tiếp tục công việc phân tích và xây dựng mô hình.</p>
<p>Hàm <strong>getPC()</strong> trả về một ma trận các thành phần chính từ ma trận ban đầu, dựa trên số lượng thành phần đã cho hoặc số lượng thành phần giữ được 80% dữ liệu (nếu num_components không được đưa ra).</p>
<p>Ma trận trọng số $W$ là ma trận chuyển đổi tuyến tính được sử dụng để chuyển đổi dữ liệu gốc vào không gian mới, trong đó mỗi thành phần chính được sắp xếp theo độ quan trọng giảm dần. Cụ thể, mỗi cột của ma trận
$W$ là một vector riêng chuẩn hóa tương ứng với các giá trị riêng của ma trận hiệp phương sai $s$.</p>
<p>Thực hiện việc nhân ma trận $W$ với hoán vị của ma trận đã chuẩn hóa $\hat{X}$ (init_matrix). Ma trận kết quả sau đó tiếp tục được hoán vị để phù hợp với hình dạng ban đầu của init_matrix và trả về kết quả.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">getPC</span><span class="p">(</span><span class="n">eigenpairs</span><span class="p">,</span> <span class="n">init_matrix</span><span class="p">,</span> <span class="n">num_components</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="s1">&#39;&#39;&#39;
</span><span class="s1">    Return matrix of principal components from init_matrix
</span><span class="s1">    &#39;&#39;&#39;</span>
    <span class="c1"># default num_components = number which to keep 80% data</span>
    <span class="k">if</span> <span class="n">num_components</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">num_components</span> <span class="o">=</span> <span class="n">findNumVec</span><span class="p">(</span><span class="n">eigenpairs</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>
    
    <span class="c1"># extracts the eigen vectors corresponding to the top num_components eigenvalues from the eigenpairs list</span>
    <span class="n">eigenvecs</span> <span class="o">=</span> <span class="p">[</span><span class="n">eigenvec</span> <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">eigenvec</span><span class="p">)</span> <span class="ow">in</span> <span class="n">eigenpairs</span><span class="p">[:</span><span class="n">num_components</span><span class="p">]]</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">e</span><span class="o">.</span><span class="n">T</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">eigenvecs</span><span class="p">])</span> <span class="c1"># stacks the eigen vectors into a weight matrix W</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">W</span> <span class="o">@</span> <span class="n">init_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

<span class="n">X_pca</span> <span class="o">=</span> <span class="n">getPC</span><span class="p">(</span><span class="n">epairs</span><span class="p">,</span> <span class="n">X_std</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Vậy là ta đã giảm được độ phức tạp cho bộ dữ liệu khá &ldquo;nhọc nhằn&rdquo; này. Hãy trực quan hóa lên biểu đồ để có một góc nhìn cụ thể và rõ ràng hơn.</p>
<p>Biểu đồ scatter plot sau khi PCA có thể giúp cho chúng ta nhìn thấy cách dữ liệu được phân bố trên các thành phần chính (principal components) và kiểm tra xem liệu chúng ta có thể tìm thấy các cluster hoặc pattern nào trong dữ liệu.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_pca</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">X_pca</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;PC1&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;PC2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Visualizing data through PCA&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="s1">&#39;datalim&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p><figure><a class="lightgallery" href="/img/stock-pcavisual.png" title="Visualizing data via PCA" data-thumbnail="/img/stock-pcavisual.png" data-sub-html="<h2>Visualizing data via PCA</h2><p>Visualizing data via PCA</p>">
        <img
            
            loading="lazy"
            src="/img/stock-pcavisual.png"
            srcset="/img/stock-pcavisual.png, /img/stock-pcavisual.png 1.5x, /img/stock-pcavisual.png 2x"
            sizes="auto"
            alt="Visualizing data via PCA" height="706"  width="928" >
    </a><figcaption class="image-caption">Visualizing data via PCA</figcaption>
    </figure></p>
<p>Okayy dựa vào biểu đồ trên, cũng có thể thấy là dữ liệu ở không gian mới đã phân tách khá rõ ràng rồi. Điều này nghĩa là phương pháp PCA đã
giảm số chiều của dữ liệu một cách hiệu quả. Bước tiếp theo chính là áp vào mô hình <code>K-Means</code> để phân cụm và tìm pattern. Chúng ta sẽ cùng chiến tiếp ở phần 2 nhé</p>
<h2 id="to-be-continue" class="headerLink">
    <a href="#to-be-continue" class="header-mark"></a>To be Continue</h2><p>Chúng ta đã thực hiện các bước tiền xử lý dữ liệu và sau đó là thực hiện PCA để giảm chiều dữ liệu một cách hiệu quả. Bài sau phần 2, OG sẽ
thực hiện training mô hình K-means clustering và cuối cùng là phân tích dữ liệu chứng khoáng.</p>
<p>Đây là kiến thức tích góp từ nhiều nguồn và nghiên cứu của nhóm OG, tất nhiên không thể tránh khỏi sai sót. Hy vọng bài viết lần này thú vị và giúp bạn đọc thư giãn, tham khảo.</p>
<p>-Mew-</p>
<hr>
<h1 id="related" class="headerLink">
    <a href="#related" class="header-mark"></a>Related</h1>
<div class="showcase-box column-2">
    <div class="showcase-image">
        <a href=/football_etl/><img
        
        loading="lazy"
        src="/img/projects-football.jpg"
        srcset="/img/projects-football.jpg, /img/projects-football.jpg 1.5x, /img/projects-football.jpg 2x"
        sizes="auto"
        alt="Football ETL Analysis"
        title="Football ETL Analysis" height="200"   width="400" ></a>
    </div>
    <h2 class="showcase-title">
        <a href=/football_etl/>Football ETL Analysis</a>
    </h2>
    <p class="showcase-summary">
        A Data Engineer project building pipeline to analyze football data
    </p>
    <a class="showcase-link" href=/football_etl/>
        Read more...
    </a>
</div>

<div class="showcase-box column-2">
    <div class="showcase-image">
        <a href=/stock_analysis_2/><img
        
        loading="lazy"
        src="/img/projects-stock.jpg"
        srcset="/img/projects-stock.jpg, /img/projects-stock.jpg 1.5x, /img/projects-stock.jpg 2x"
        sizes="auto"
        alt="Stock Analysis P2"
        title="Stock Analysis P2" height="200"   width="400" ></a>
    </div>
    <h2 class="showcase-title">
        <a href=/stock_analysis_2/>Stock Analysis P2</a>
    </h2>
    <p class="showcase-summary">
        Stock Analysis using PCA and K-means
    </p>
    <a class="showcase-link" href=/stock_analysis_2/>
        Read more...
    </a>
</div>
</div>

        <div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 31 Aug 2023</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share"><button title="Share on Facebook" data-sharer="facebook" data-url="https://phonghuynh.netlify.app/stock_analysis/" data-hashtag="Machine learning"><span class="fab fa-facebook-square fa-fw"></span></button><button title="Share on Linkedin" data-sharer="linkedin" data-url="https://phonghuynh.netlify.app/stock_analysis/"><span class="fab fa-linkedin fa-fw"></span></button></div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/machine-learning/">Machine learning</a>,&nbsp;<a href="/tags/math/">math</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/football_etl_2/" class="prev" rel="prev" title="Football ETL Analysis P2"><i class="fas fa-angle-left fa-fw"></i>Football ETL Analysis P2</a>
            <a href="/stock_analysis_2/" class="next" rel="next" title="Stock Analysis P2">Stock Analysis P2<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank" rel="noopener noreferrer">OG</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
            <div class="footer-line"></div>
            <div class="footer-line">
            </div>
        </div></footer></div>

    <div id="fixed-buttons"><a href="#back-to-top" id="back-to-top-button" class="fixed-button" title="Back to Top">
            <i class="fas fa-arrow-up fa-fw"></i>
        </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
            <i class="fas fa-comment fa-fw"></i>
        </a>
    </div><div class="assets"><link rel="stylesheet" href="/lib/lightgallery/lightgallery.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/katex/copy-tex.min.css">
        <noscript><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"></noscript><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"sharerjs":true,"table":{"sort":true}};</script><script type="text/javascript" src="/lib/tablesort/tablesort.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lightgallery.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-thumbnail.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-zoom.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js" defer></script><script type="text/javascript" src="/lib/katex/auto-render.min.js" defer></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js" defer></script><script type="text/javascript" src="/lib/katex/mhchem.min.js" defer></script><script type="text/javascript" src="/js/katex.min.js" defer></script><script type="text/javascript" src="/js/theme.min.js" defer></script></div>
</body>

</html>