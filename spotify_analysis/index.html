

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" />
    <title>Spotify Analysis - OG Home</title><meta name="Description" content="A End to End ELT data pipeline to Analyze Spotify Data and build recommendation system"><meta property="og:title" content="Spotify Analysis" />
<meta property="og:description" content="A End to End ELT data pipeline to Analyze Spotify Data and build recommendation system" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://phonghuynh.netlify.app/spotify_analysis/" /><meta property="og:image" content="https://raw.githubusercontent.com/PhongHuynh0394/Spotify-Analysis-with-PySpark/refs/heads/main/image/spotify-diagram.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-10T18:41:00+07:00" />
<meta property="article:modified_time" content="2023-12-10T18:41:00+07:00" /><meta property="og:site_name" content="OG Home" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://raw.githubusercontent.com/PhongHuynh0394/Spotify-Analysis-with-PySpark/refs/heads/main/image/spotify-diagram.png"/>

<meta name="twitter:title" content="Spotify Analysis"/>
<meta name="twitter:description" content="A End to End ELT data pipeline to Analyze Spotify Data and build recommendation system"/>
<meta name="application-name" content="OG">
<meta name="apple-mobile-web-app-title" content="OG">

<meta name="theme-color" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="https://phonghuynh.netlify.app/spotify_analysis/" /><link rel="prev" href="https://phonghuynh.netlify.app/spotify_analysis_en/" />
<link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/color.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/fontawesome-free/all.min.css">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/animate/animate.min.css">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Spotify Analysis",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/phonghuynh.netlify.app\/spotify_analysis\/"
        },"image": [{
                            "@type": "ImageObject",
                            "url": "https:\/\/phonghuynh.netlify.app\/img\/oggy.png",
                            "width":  240 ,
                            "height":  240 
                        }],"genre": "posts","keywords": "streamlit, API, ELT, Data Engineer, Machine Learning, Distributed System, Hadoop, Spark, Docker, Terraform, Visualization, PowerBI","wordcount":  3046 ,
        "url": "https:\/\/phonghuynh.netlify.app\/spotify_analysis\/","datePublished": "2023-12-10T18:41:00+07:00","dateModified": "2023-12-10T18:41:00+07:00","publisher": {
            "@type": "Organization",
            "name": "OG Page","logo": "https:\/\/phonghuynh.netlify.app\/favicon.icon"},"authors": [{
                        "@type": "Person",
                        "name": "OG"                    
                    }],"description": "A End to End ELT data pipeline to Analyze Spotify Data and build recommendation system"
    }
    </script><script src="//instant.page/5.2.0" defer type="module" integrity="sha384-jnZyxPjiipYXnSU0ygqeac2q7CVYMbh84q0uHVRRxEtvFPiQYbXWUorga2aqZJ0z"></script>
</head>

<body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">
        function setTheme(theme) {document.body.setAttribute('theme', theme); document.documentElement.style.setProperty('color-scheme', theme === 'light' ? 'light' : 'dark'); window.theme = theme;   window.isDark = window.theme !== 'light' }
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {let theme = localStorage.getItem('theme');theme === 'light' || theme === 'dark' || theme === 'black' ? setTheme(theme) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light')); } else { if ('auto' === 'light' || 'auto' === 'dark' || 'auto' === 'black') setTheme('auto'), saveTheme('auto'); else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');}
        let metaColors = {'light': '#f8f8f8','dark': '#252627','black': '#000000'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
        window.switchThemeEventSet = new Set()
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="OG Home">OG Home</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/blogs/" title="OG&#39;s blogs"> Blogs </a><a class="menu-item" href="/projects/" title="OG&#39;s Projects"> Projects </a><a class="menu-item" href="/tags/" title="Tags of blogs"> Tags </a><a class="menu-item" href="/about/"> About </a><a class="menu-item" href="https://drive.google.com/file/d/1jIJxzyFMc7zy78tsBJc7ShFyV8sQTBS7/view?usp=sharing" title="Resume" rel="noopener noreferrer" target="_blank"> Resume 🔗 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="OG Home">OG Home</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/blogs/" title="OG&#39;s blogs">Blogs</a><a class="menu-item" href="/projects/" title="OG&#39;s Projects">Projects</a><a class="menu-item" href="/tags/" title="Tags of blogs">Tags</a><a class="menu-item" href="/about/" title="">About</a><a class="menu-item" href="https://drive.google.com/file/d/1jIJxzyFMc7zy78tsBJc7ShFyV8sQTBS7/view?usp=sharing" title="Resume" rel="noopener noreferrer" target="_blank">Resume 🔗</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
            <div class="container"><div class="toc" id="toc-auto">
        <h2 class="toc-title">Contents</h2>
        <div class="toc-content always-active" id="toc-content-auto"><nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#data-schema">Data Schema</a></li>
    <li><a href="#infrastructure">Infrastructure</a>
      <ul>
        <li><a href="#apache-hadoop">Apache Hadoop</a></li>
        <li><a href="#prefect">Prefect</a></li>
        <li><a href="#dremio">Dremio</a></li>
        <li><a href="#mongodb-with-terraform">MongoDB with Terraform</a></li>
      </ul>
    </li>
    <li><a href="#pipeline-1">Pipeline 1</a></li>
    <li><a href="#pipeline-2">Pipeline 2</a>
      <ul>
        <li><a href="#pyspark">PySpark</a></li>
        <li><a href="#data-processing">Data Processing</a></li>
      </ul>
    </li>
    <li><a href="#analytic-layer">Analytic layer</a></li>
    <li><a href="#machine-learning-and-dashboard">Machine learning and Dashboard</a>
      <ul>
        <li><a href="#k-nearest-neighbors-knn">K-Nearest Neighbors (KNN)</a></li>
        <li><a href="#powerbi-dashboard">PowerBI Dashboard</a></li>
      </ul>
    </li>
    <li><a href="#application">Application</a></li>
    <li><a href="#final-thoughts">Final Thoughts</a></li>
  </ul>
</nav></div>
    </div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Spotify Analysis</h1><div class="post-meta">
            <div class="post-meta-line">
                <span class="post-author"><span class='author'><span class="author fas fa-user-circle fa-fw"></span><span class='screen-reader-text'>  </span><a href='https://phonghuynh.netlify.app/authors/og'>OG</a></span>
                </span>&nbsp;<span class="post-category">included in </span>&nbsp;<span class="post-category">category <a href="/categories/projects/"><i class="far fa-folder fa-fw"></i>projects</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="10 Dec 2023">10 Dec 2023</time>&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;15 minutes&nbsp;</div>
        </div><div class="featured-image"><img
        
        loading="eager"
        src="/img/project-spotify.jpg"
        srcset="/img/project-spotify.jpg, /img/project-spotify.jpg 1.5x, /img/project-spotify.jpg 2x"
        sizes="auto"
        alt="A End to End ELT data pipeline to Analyze Spotify Data and build recommendation system"
        title="A End to End ELT data pipeline to Analyze Spotify Data and build recommendation system" height="auto"   width="auto" ></div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#data-schema">Data Schema</a></li>
    <li><a href="#infrastructure">Infrastructure</a>
      <ul>
        <li><a href="#apache-hadoop">Apache Hadoop</a></li>
        <li><a href="#prefect">Prefect</a></li>
        <li><a href="#dremio">Dremio</a></li>
        <li><a href="#mongodb-with-terraform">MongoDB with Terraform</a></li>
      </ul>
    </li>
    <li><a href="#pipeline-1">Pipeline 1</a></li>
    <li><a href="#pipeline-2">Pipeline 2</a>
      <ul>
        <li><a href="#pyspark">PySpark</a></li>
        <li><a href="#data-processing">Data Processing</a></li>
      </ul>
    </li>
    <li><a href="#analytic-layer">Analytic layer</a></li>
    <li><a href="#machine-learning-and-dashboard">Machine learning and Dashboard</a>
      <ul>
        <li><a href="#k-nearest-neighbors-knn">K-Nearest Neighbors (KNN)</a></li>
        <li><a href="#powerbi-dashboard">PowerBI Dashboard</a></li>
      </ul>
    </li>
    <li><a href="#application">Application</a></li>
    <li><a href="#final-thoughts">Final Thoughts</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><div class="details admonition success open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-check-circle fa-fw"></i>Shout out cho những member tâm huyết<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Project này có thể hoàn thiện cũng là sự đóng góp của các thành viên trong team: Ngọc Tuấn (Data Engineer), Duy Sơn (Data Scientist), Vĩ Thiên (Data Analyst)</div>
        </div>
    </div>
<a target="_blank" href="https://github.com/PhongHuynh0394/Spotify-Analysis-with-PySpark" title="PhongHuynh0394" class="friend-link" rel="noopener noreferrer">
    <div class="friend-link-div">
        <div class="friend-link-avatar"><img
        
        loading="lazy"
        src="/img/github-logo.png"
        srcset="/img/github-logo.png, /img/github-logo.png 1.5x, /img/github-logo.png 2x"
        sizes="auto"
        alt="/img/github-logo.png"
        title="/img/github-logo.png" height="560"   width="560" ></div>
        <div class="friend-link-info">
            <div class="friend-name-div">
                <i class="fas fa-user-circle fa-fw"></i>
                <i class="friend-name">PhongHuynh0394</i>
            </div>
            <p class="friend-bio">Spotify Analysis with PySpark</p>
        </div>
    </div>
</a>
<p><strong><a href="/spotify_analysis_en/" rel="">English Version Available</a></strong></p>
<p>Hello ! Hello ! Lại là OG đây. Lần này mình sẽ cùng nhau xây dựng
End-to-End ELT data pipeline và một Recommender System dựa trên dữ liệu phân tích từ Spotify API nhé.
Không dài dòng nữa, bắt đầu thôi nào.</p>
<h2 id="introduction" class="headerLink">
    <a href="#introduction" class="header-mark"></a>Introduction</h2><p>Project lần này là xây dựng hệ thống phân tích nhạc từ Spotify như diagram sau</p>
<figure><img src="https://raw.githubusercontent.com/PhongHuynh0394/Spotify-Analysis-with-PySpark/refs/heads/main/image/spotify-diagram.png"/>
</figure>

<p>Trong diagram bao gồm những thành phần sau:</p>
<ol>
<li><a href="#infrastructure" rel=""><strong>Infrastructure</strong></a>: Ta sẽ sử dụng Docker để set up cho hầu hết các frameworks sử dụng trong hệ thống và Terraform (Optional) để set up cho MongoDB.</li>
<li><a href="#pipeline-1" rel=""><strong>Pipeline 1</strong></a>: Đây là pipeline sẽ thực hiện incremental load vào MongoDB mỗi kéo data từ Spotify API về.</li>
<li><a href="#pipeline-2" rel=""><strong>Pipeline 2</strong></a>: Data Pipeline này thực hiện việc chính là ELT (Extract, Load, Transform) để xử lý và chuẩn hóa dữ liệu JSON từ MongoDB. Việc xử lý cấu trúc dữ liệu phức tạp và lồng nhau của JSON chủ yếu sẽ được thực hiện bằng pySpark (Python API của Apache Spark) ngay trên HDFS (Hadoop Distributed File System)</li>
<li><a href="#analytic-layer" rel=""><strong>Analytic Layer</strong></a>: Để có thể sử dụng phân tích được, ta sẽ apply một lớp phân tích lên trên Hadoop. Ở project này ta sẽ sử dụng Dremio để cho việc đó.</li>
<li><a href="#machine-learning-and-dashboard" rel=""><strong>Machine learning and Dashboard</strong></a>: Ở phần này chủ yếu là việc training mô hình machine learning model cho hệ thống gợi ý âm nhạc spoitfy. Ngoài ra cũng có thể PowerBI để tạo các Dashboard để phân tích từ dữ liệu ở Dremio.</li>
<li><a href="#application" rel=""><strong>Application</strong></a>: Cuối cùng ta sẽ dùng Streamlit để viết một web đơn giản để làm hệ thống gợi ý và tìm kiếm nhạc. Ngoài ra người dùng cũng có thể tương tác với BI Dashboard ở layer này</li>
</ol>
<h2 id="data-schema" class="headerLink">
    <a href="#data-schema" class="header-mark"></a>Data Schema</h2><p>Nguồn data của chúng ta đến từ <a href="https://developer.spotify.com/documentation/web-api" target="_blank" rel="noopener noreferrer">Spotify API</a>. Ngoài ra ta cũng sẽ cào thêm một danh sách
nghệ sĩ trên Spotify từ trang <a href="https://kworb.net/spotify/artists.html#google_vignette" target="_blank" rel="noopener noreferrer">Sportify Artists</a>. Data sau khi đã được
xử lý cuối cùng sẽ có schema như sau:</p>
<figure><img src="https://raw.githubusercontent.com/PhongHuynh0394/Spotify-Analysis-with-PySpark/refs/heads/main/image/schema.png"/>
</figure>

<h2 id="infrastructure" class="headerLink">
    <a href="#infrastructure" class="header-mark"></a>Infrastructure</h2><p>Ta sẽ sử dụng chủ yếu là Docker để cấu hình cho hầu hết các framework trong hệ thống thông qua <code>docker-compose.yml</code> file. Chỉ riêng có MongoDB Atlas thì có thể set up bằng nhiều cách khác nhau.</p>
<h3 id="apache-hadoop" class="headerLink">
    <a href="#apache-hadoop" class="header-mark"></a>Apache Hadoop</h3><p>Đầu tiên ta sẽ set up Apache Hadoop bằng Docker Compose. Như đã biết Hadoop là một framework được viết bằng Java được giới thiệu bởi Google vào năm 2006 và ứng dụng công nghệ hệ thống
phân tán để lưu trữ và xử lý Big Data. Hadoop được xây dựng đựa trên ba thành phần chính:</p>
<ol>
<li><strong>HDFS (Hadoop Distributed File System)</strong>: là hệ thống file phân tán được sử dụng để lưu trữ dữ liệu</li>
<li><strong>YARN (Yet Another Resouce Negotiator)</strong>: là một framework quản lý và phân bổ tài nguyên để vận hành các ứng dụng trên Hadoop</li>
<li><strong>MapReduce</strong>: là một framework lập trình xử lý và tính toán dữ liệu song song trong môi trường hệ thống phân tán.</li>
</ol>
<figure><img src="https://i.imgur.com/6svuJjx.jpeg"/><figcaption>
            <h4>HDFS và YARN trong Hadoop</h4>
        </figcaption>
</figure>

<p>Trong project này, ta sẽ lượt bớt phần setup MapReduce trong Hadoop Cluster và thay vào đó chỉ là HDFS và YARN thôi (vì phần xử lý tính toán ta sẽ thay thế bằng Apache Spark).
Ngoài ra vì là project PoC (Proof of Concept), ta sẽ đơn giản hóa Hadoop cluster với 1 Master Node, 1 Worker Node mà thôi.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">hadoop_datanode</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">hadoop_namenode</span><span class="p">:</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">namenode</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l">namenode</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">apache/hadoop:3</span><span class="w">
</span><span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l">namenode</span><span class="w">
</span><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l">bash -c &#34;if [ ! -f /tmp/hadoop-root/dfs/name/.formatted ]; then hdfs namenode -format &amp;&amp; touch /tmp/hadoop-root/dfs/name/.formatted; fi &amp;&amp; hdfs namenode&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="m">9870</span><span class="p">:</span><span class="m">9870</span><span class="w">
</span><span class="w">      </span>- <span class="m">8020</span><span class="p">:</span><span class="m">8020</span><span class="w">
</span><span class="w">      </span>- <span class="m">9000</span><span class="p">:</span><span class="m">9000</span><span class="w">
</span><span class="w">    </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span><span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">.env</span><span class="w">
</span><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">hadoop_namenode:/tmp/hadoop-root/dfs/name</span><span class="w">
</span><span class="w">    </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">docker-net</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="nt">datanode</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">apache/hadoop:3</span><span class="w">
</span><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l">datanode</span><span class="w">
</span><span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l">datanode </span><span class="w">
</span><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;hdfs&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;datanode&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="m">9864</span><span class="p">:</span><span class="m">9864</span><span class="w">
</span><span class="w">      </span>- <span class="m">9866</span><span class="p">:</span><span class="m">9866</span><span class="w">
</span><span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="m">50010</span><span class="w">
</span><span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">.env</span><span class="w">
</span><span class="w">    </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">hadoop_datanode:/tmp/hadoop-root/dfs/data</span><span class="w">
</span><span class="w">    </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">docker-net</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="nt">resourcemanager</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">apache/hadoop:3</span><span class="w">
</span><span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l">resourcemanager</span><span class="w">
</span><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;yarn&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;resourcemanager&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">       </span>- <span class="m">8088</span><span class="p">:</span><span class="m">8088</span><span class="w">
</span><span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">.env</span><span class="w">
</span><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">./test.sh:/opt/test.sh</span><span class="w">
</span><span class="w">    </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">docker-net</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="nt">nodemanager</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">apache/hadoop:3</span><span class="w">
</span><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;yarn&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;nodemanager&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">.env</span><span class="w">
</span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="m">8188</span><span class="p">:</span><span class="m">8188</span><span class="w">
</span><span class="w">    </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">docker-net</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Ta sẽ chủ yếu sử dụng HDFS để làm Datalake cho project này. Ngoài ra có thể truy cập vào các services của Hadoop thông qua:</p>
<ul>
<li>Namenode: <code>localhost:9870</code></li>
<li>Datanode: <code>localhost:9864</code></li>
<li>Resouces Manager (YARN): <code>localhost:8088</code></li>
</ul>
<h3 id="prefect" class="headerLink">
    <a href="#prefect" class="header-mark"></a>Prefect</h3><p>Prefect là một orchestration tool khá dễ dùng và dễ bắt đầu. Với giao diện bắt mắt và tính dễ tiếp cận, framework này giúp cho việc
lên lịch, sắp xếp và chạy các task hay thậm chí là chạy song song (concurrent task). Ta sẽ set up một prefect server và prefect API bằng docker như sau:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="w">  </span><span class="nt">prefect-server</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l">./prefect</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">prefect</span><span class="w">
</span><span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l">prefect-server</span><span class="w">
</span><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l">prefect-server</span><span class="w">
</span><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">prefect:/root/.prefect</span><span class="w">
</span><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l">prefect server start</span><span class="w">
</span><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">PREFECT_UI_URL=http://127.0.0.1:4200/api</span><span class="w">
</span><span class="w">      </span>- <span class="l">PREFECT_API_URL=http://127.0.0.1:4200/api</span><span class="w">
</span><span class="w">      </span>- <span class="l">PREFECT_SERVER_API_HOST=0.0.0.0</span><span class="w">
</span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="m">4200</span><span class="p">:</span><span class="m">4200</span><span class="w">
</span><span class="w">    </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">docker-net</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="nt">prefect</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">prefect:latest</span><span class="w">
</span><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l">prefect</span><span class="w">
</span><span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l">always</span><span class="w">
</span><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="s2">&#34;./prefect/flows:/opt/prefect/flows&#34;</span><span class="w">
</span><span class="w">      </span>- <span class="s2">&#34;/etc/timezone:/etc/timezone:ro&#34;</span><span class="w">
</span><span class="w">      </span>- <span class="s2">&#34;/etc/localtime:/etc/localtime:ro&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">.env</span><span class="w">
</span><span class="w">    </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">docker-net</span><span class="w">
</span><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">prefect-server</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p><figure><img src="https://i.imgur.com/x5kovYF.jpeg"/>
</figure>

<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>Tại sao lại set up Prefect Server và Prefect riêng với nhau ?<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Có nhiều lý do để chọn set up riêng Prefect Server và Prefect riêng biệt, nhưng thường lý do quan trọng nhất là ta muốn tùy chỉnh
môi trường chạy flow mà không ảnh hưởng đến server. Prefect Server sẽ đóng vai trò Backend xử lý các tín hiệu từ các container khác thông qua prefect API. Điều này giúp tăng tính ổn định cho hệ
thống và dễ để bảo trì, debug.</div>
        </div>
    </div></p>
<p>Và trong lúc setup, ta sẽ không sử dụng built-in image <a href="https://hub.docker.com/r/prefecthq/prefect" target="_blank" rel="noopener noreferrer">PrefectHQ</a> mà thay vào đó sẽ tự build một custom image để có thể dễ tùy biến. Ngoài các module cho python
trong <code>requirements.txt</code> ta sẽ cần phải config thêm Java 11 để tương thích với pyspark</p>
<div class="highlight" title="Dockerfile"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="k">ARG</span> <span class="nv">IMAGE_VARIANT</span><span class="o">=</span>slim-buster<span class="err">
</span><span class="err"></span><span class="k">ARG</span> <span class="nv">OPENJDK_VERSION</span><span class="o">=</span><span class="m">11</span>
<span class="k">ARG</span> <span class="nv">PYTHON_VERSION</span><span class="o">=</span><span class="m">3</span>.11.0<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">FROM</span><span class="s"> python:${PYTHON_VERSION}-${IMAGE_VARIANT} AS py3</span><span class="err">
</span><span class="err"></span><span class="k">FROM</span><span class="s"> openjdk:${OPENJDK_VERSION}-${IMAGE_VARIANT}</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>py3 / /<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /opt/prefect</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> requirements.txt .<span class="err">
</span><span class="err"></span><span class="k">RUN</span> pip install -r requirements.txt --trusted-host pypi.python.org --no-cache-dir<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">COPY</span> flows /opt/prefect/flows<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c"># Run our flow script when the container starts</span><span class="err">
</span><span class="err"></span><span class="k">CMD</span> <span class="p">[</span><span class="s2">&#34;python&#34;</span><span class="p">,</span> <span class="s2">&#34;flows/main_flow.py&#34;</span><span class="p">]</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Ta có thể truy cập UI Prefect thông qua <code>localhost:4042</code> để trigger pipeline.</p>
</blockquote>
<h3 id="dremio" class="headerLink">
    <a href="#dremio" class="header-mark"></a>Dremio</h3><p>Bây giờ ta đã có một datalake là hadoop HDFS, tuy nhiên Object Storange như HDFS không cung cấp khả năng phân tích hay truy vấn, do đó ta sẽ cần xây dựng một Analytic Layer trên HDFS. Ở vị trí này có khá nhiều lựa chọn như Trino, Hive,&hellip; Tuy nhiên ở project này ta sẽ dùng
một Lakehouse platform là Dremio.</p>
<p>Dremio là một mã nguồn mở data-as-a-service hỗ trợ phân tích và dễ dàng kết nối với đa dạng nguồn data khác nhau và tất nhiên trong đó có Hadoop. Dremio cung cấp khả truy vấn mạnh mẽ
với SQL engine và một giao diện thân thiện</p>
<figure><img src="https://docs.dremio.com/assets/images/simple-arch-f14219fc3923321c4f39dab0fd8cb002.png"/><figcaption>
            <h4>Dremio Cluster</h4>
        </figcaption>
</figure>

<p>Ta sẽ config một dremio cluster với <a href="https://hub.docker.com/r/dremio/dremio-oss" target="_blank" rel="noopener noreferrer">dremio-oss</a> image. Image này bao gồm:</p>
<ul>
<li>Embedded Zookeeper</li>
<li>Master Coordinator</li>
<li>Execuor</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">dremio</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">dremio/dremio-oss</span><span class="w">
</span><span class="w">  </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l">dremio</span><span class="w">
</span><span class="w">  </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l">dremio</span><span class="w">
</span><span class="w">  </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l">always</span><span class="w">
</span><span class="w">  </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">dremio_data:/var/lib/dremio</span><span class="w">
</span><span class="w">    </span>- <span class="l">dremio_data:/localFiles</span><span class="w">
</span><span class="w">    </span>- <span class="l">dremio_data:/opt/dremio</span><span class="w">
</span><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;9047:9047&#34;</span><span class="w">   </span><span class="c"># Web UI (HTTP)</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;31010:31010&#34;</span><span class="w"> </span><span class="c"># ODBC/JDBC client</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;32010:32010&#34;</span><span class="w"> </span><span class="c"># Apache Arrow Flight clients</span><span class="w">
</span><span class="w">  </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">docker-net</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Sau khi deploy thành công, ta có thể đăng nhập vào dremio ở <code>localhost:9047</code> với username=dremio và password=dremio123</p>
</blockquote>
<h3 id="mongodb-with-terraform" class="headerLink">
    <a href="#mongodb-with-terraform" class="header-mark"></a>MongoDB with Terraform</h3><div class="details admonition warning open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-exclamation-triangle fa-fw"></i>Warning<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Ở bước set up này cần phải đăng ký <a href="https://www.mongodb.com/cloud/atlas/register" target="_blank" rel="noopener noreferrer">tài khoản MongoDB Atlas</a> và cài đặt <a href="https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli" target="_blank" rel="noopener noreferrer">Terraform</a></div>
        </div>
    </div>
<p><strong>Về Terraform</strong>: HashiCorp Terraform là một công cụ &ldquo;insfrastructure as code&rdquo; giúp ta setup và config những tài nguyên cả on-prem hay cloud chỉ với việc viết configuration file.</p>
<p><strong>MongoDB Atlas</strong>: có thể không cần config trong docker compose và hoàn toàn có thể set up thủ công ở <a href="https://www.mongodb.com/products/platform/atlas-database" target="_blank" rel="noopener noreferrer">Đây</a>. Tuy nhiên trong phần này thì ta sẽ
làm điều đó tự động bằng Terraform.</p>
<figure><img src="https://webassets.mongodb.com/_com_assets/cms/Screenshot%202024-01-04%20at%209.03.59%E2%80%AFAM-38glhpd7xa.png"/>
</figure>

<p>Đầu tiên ta càn phải có tài khoản MongoDB Atlas, sau đó bước đầu tiên là sẽ set up vài variables trong file <code>variable.tf</code>. File này sẽ lưu đa số các biến môi trường, API key, token,&hellip;.
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>Note<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Chi tiết cách set up file <code>variable.tf</code> có thể đọc ở <a href="https://github.com/PhongHuynh0394/Spotify-Analysis-with-PySpark/tree/main/mongo_terraform" target="_blank" rel="noopener noreferrer">Đây</a></div>
        </div>
    </div></p>
<p>Với terraform, ta sẽ chủ yếu chạy file <code>main.tf</code> vì file này sẽ lưu mọi config về cluster muốn deploy.</p>
<p>Ta sẽ sử dụng <a href="https://registry.terraform.io/providers/mongodb/mongodbatlas/latest" target="_blank" rel="noopener noreferrer">MongoDB Atlas Provider</a> và gọi lại các variables (được set trong file file <code>variable.tf</code> trước đó)</p>
<div class="highlight" title="main.tf"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-HCL" data-lang="HCL"><span class="k">terraform</span> {
  <span class="k">required_providers</span> {
<span class="n">    mongodbatlas</span> <span class="o">=</span> {
<span class="n">      source</span> <span class="o">=</span> <span class="s2">&#34;mongodb/mongodbatlas&#34;</span><span class="p">,</span>
<span class="n">      version</span> <span class="o">=</span> <span class="s2">&#34;1.8.0&#34;</span>
    }
  }
}

<span class="k">provider</span> <span class="s2">&#34;mongodbatlas&#34;</span> {
<span class="n">  public_key</span> <span class="o">=</span> <span class="k">var</span><span class="p">.</span><span class="k">public_key</span>
<span class="n">  private_key</span> <span class="o">=</span> <span class="k">var</span><span class="p">.</span><span class="k">private_ke</span>
}
</code></pre></td></tr></table>
</div>
</div><p><div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>Tip<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Chi tiết các resources có thể tham khảo tại đây <a href="https://registry.terraform.io/providers/mongodb/mongodbatlas/latest/docs" target="_blank" rel="noopener noreferrer">mongodbatlas Provider terraform docs</a></div>
        </div>
    </div>
Ngoài ra ta cũng sẽ tạo một vài resources khác để hoàn thiện phần setting up:</p>
<ul>
<li><code>mongdodbatlas_project</code>: Config project khỏi tạo</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="k">resource</span> <span class="s2">&#34;mongodbatlas_project&#34; &#34;spotify_project&#34;</span> {
<span class="n">  name</span> <span class="o">=</span> <span class="s2">&#34;spotify_project&#34;</span>
<span class="n">  org_id</span> <span class="o">=</span> <span class="k">var</span><span class="p">.</span><span class="k">org_id</span>
<span class="n">  is_collect_database_specifics_statistics_enabled</span> <span class="o">=</span> <span class="kt">true</span>
<span class="n">  is_data_explorer_enabled</span> <span class="o">=</span> <span class="kt">true</span>
<span class="n">  is_performance_advisor_enabled</span> <span class="o">=</span> <span class="kt">true</span>
<span class="n">  is_realtime_performance_panel_enabled</span> <span class="o">=</span> <span class="kt">true</span>
<span class="n">  is_schema_advisor_enabled</span> <span class="o">=</span> <span class="kt">true</span>
}
</code></pre></td></tr></table>
</div>
</div><ul>
<li><code>mongodbatlas_cluster</code>: setup cluster cho atlas, ta sẽ host trên gcp (có thể chọn azure hay aws đều được)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="k">resource</span> <span class="s2">&#34;mongodbatlas_cluster&#34; &#34;spotify&#34;</span> {
<span class="n">  name</span> <span class="o">=</span> <span class="k">var</span><span class="p">.</span><span class="k">cluster_name</span>
<span class="n">  project_id</span> <span class="o">=</span> <span class="k">mongodbatlas_project</span><span class="p">.</span><span class="k">spotify_project</span><span class="p">.</span><span class="k">id</span>
<span class="n">  backing_provider_name</span> <span class="o">=</span> <span class="s2">&#34;GCP&#34;</span>
<span class="n">  provider_name</span> <span class="o">=</span> <span class="s2">&#34;TENANT&#34;</span>
<span class="n">  provider_instance_size_name</span> <span class="o">=</span> <span class="k">var</span><span class="p">.</span><span class="k">cluster_size</span>
<span class="n">  provider_region_name</span> <span class="o">=</span> <span class="k">var</span><span class="p">.</span><span class="k">region</span>
}
</code></pre></td></tr></table>
</div>
</div><p><strong>Chạy lệnh deploy cluster</strong></p>
<p>Sau khi đã chuẩn bị hoàn tất các configuration, việc còn lại là chạy các lệnh tf cli để set up plan</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">terraform init <span class="c1"># set up provider for atlas</span>
terraform plan
</code></pre></td></tr></table>
</div>
</div><p>Sau đó, nhập <code>yes</code> để tiếp tục quá trình set up. cuối dùng để deploy cluster thì ta sẽ chỉ cần nhập <code>terraform apply</code>. sau đó ta sẽ nhận được kết quả giống thế này</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">Apply complete! Resources: <span class="m">4</span> added, <span class="m">0</span> changed, <span class="m">0</span> destroyed.

Outputs:

<span class="nv">password</span> <span class="o">=</span> <span class="s2">&#34;123&#34;</span>
<span class="nv">srv_address</span> <span class="o">=</span> <span class="s2">&#34;mongodb+srv://spotify-cluster.kdglyul.mongodb.net&#34;</span>
<span class="nv">user</span> <span class="o">=</span> <span class="s2">&#34;root&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>Hãy chú ý các thông tin ở ba dòng cuối là password, srv_address và user. ta sẽ cần những thông tin này cho file <code>.env</code> để set up connection với Atlas sau này. Đó sẽ là các biến <code>MONGODB_PASS</code>, <code>MONGODB_SRV</code> và <code>MONGODB_USER</code></p>
<div class="details admonition tip open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>Tip<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Để xóa mọi thứ trên mongodb atlas kể cả cluster thì chỉ cần chạy lệnh <code>terraform destroy</code>. hãy cẩn thận vì lệnh này có thể xóa hết cluster và cả data</div>
        </div>
    </div>
<h2 id="pipeline-1" class="headerLink">
    <a href="#pipeline-1" class="header-mark"></a>Pipeline 1</h2><p>Data pipeline này thực hiện việc chính là pooling api để crawl data từ spotify api và incremental load data vào mongodb atlas. để giải quyết vấn đề
về rate limit, ta sẽ config cho flow này được tự động trigger mỗi 2 phút 5 giây để crawl một batch gồm lần lượt thông tin 5 artists từ file danh sách <code>artists.txt</code></p>
<figure><img src="https://raw.githubusercontent.com/PhongHuynh0394/Spotify-Analysis-with-PySpark/main/image/pipline1-b.jpg"/>
</figure>

<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw"></i>Incremental load<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">Khác với full load khi ta load data và overwrite tất cả trong database , incremental load hay được gọi là delta load thực hiện việc
chỉ load phần data update hoặc data mới mà không load lại tất cả các historical data trước đó. pipeline này sẽ luôn cào và ingest thông tin nghệ sĩ mới nhất trong file <code>artists.txt</code> để gọi spotify api qua mỗi batch
và dùng một file <code>log.txt</code> để đánh dấu vị trí index và số lượng nghệ sĩ đã cào thành công</div>
        </div>
    </div>
<h2 id="pipeline-2" class="headerLink">
    <a href="#pipeline-2" class="header-mark"></a>Pipeline 2</h2><p>Đây là phần chính của project này và hầu hết các tác vụ xử lý sẽ thực hiện trong pipeline này. Pipeline này chính là một ELT (Extract - Load - Transform) data pipeline
với nguồn raw là các collections từ MongoDB, sau đó sẽ được xử lý bằng spark và lưu trong hdfs. Ta đồng thời sẽ xây dựng một <strong>Medallion architecture</strong> ngay trong hdfs để phân vùng cho các loại data.</p>
<div class="details admonition info">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-info-circle fa-fw"></i>Medallion architecture<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>kiến trúc này được Databricks giới thiệu là một &ldquo;data design pattern&rdquo; dùng để tổ chức data trong lakehouse với mục tiêu là để
cải thiện chất lượng data qua từng layer của kiến trúc này (bronze -&gt; silver -&gt; gold)</p>
<figure><img src="https://www.databricks.com/sites/default/files/inline-images/building-data-pipelines-with-delta-lake-120823.png?v=1702318922"/>
</figure>
</div>
        </div>
    </div>
<h3 id="pyspark" class="headerLink">
    <a href="#pyspark" class="header-mark"></a>PySpark</h3><p><div class="details admonition question">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-question-circle fa-fw"></i>Apache Spark được set up ở đâu ?<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>Có lẽ bạn sẽ thắc mắc tại sao không thấy Apache Spark được set up. có 2 lý do:</p>
<ol>
<li>Tài nguyên hạn chế: đối với project hiện tại khi đã có quá nhiều services được chạy cùng lúc bởi docker containers, set up thêm spark cluster có thể sẽ quá tải và không đủ tài nguyên để deploy tất cả.</li>
<li>Data nhỏ: thành thực thì số lượng data phải process không thực sự quá lớn (khoảng hơn 200k quan sát) thì việc sử dụng spark có thể sẽ lãng phí tài nguyên. tuy nhiên vì mục đích học tập và thực hiện project poc, ta sẽ sử dụng spark với local mode thay vì set up standardlone mode với cluster</li>
</ol>
</div>
        </div>
    </div>
Apache Spark có nhiều chế độ chạy mà ta có thể tùy vào quy mô project mà sử dụng:</p>
<ul>
<li><code>local[*]</code>: là chế độ <strong>local</strong>, chế độ này cho phép chạy mà không cần phải setup spark cluster</li>
<li><code>spark://{master-node-name}:7077</code>: chế độ <strong>standalone</strong> và ta sẽ kết nối với một spark cluster</li>
<li><code>yarn-client</code>: chế độ <strong>yarn-client</strong></li>
<li><code>yarn-cluster</code>: chế độ <strong>yarn-cluster</strong></li>
<li><code>mesos://host:5050</code>: <strong>mesos cluster</strong></li>
</ul>
<p>Và ở project này ta sẽ sử dụng <strong>local</strong> mode để tối ưu tài nguyên cũng như phù hợp với kích thước dataset. để tiện lợi cho việc tạo SparkSession, ta sẽ viết một <code>sparkIO</code> bằng <code>contextlib</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="kn">from</span> <span class="nn">pyspark</span> <span class="kn">import</span> <span class="n">SparkConf</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>

<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">SparkIO</span><span class="p">(</span><span class="n">conf</span><span class="p">:</span> <span class="n">SparkConf</span> <span class="o">=</span> <span class="n">SparkConf</span><span class="p">()):</span>
    <span class="n">app_name</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;spark.app.name&#34;</span><span class="p">)</span>
    <span class="n">master</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;spark.master&#34;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Create SparkSession app </span><span class="si">{</span><span class="n">app_name</span><span class="si">}</span><span class="s1"> with </span><span class="si">{</span><span class="n">master</span><span class="si">}</span><span class="s1"> mode&#39;</span><span class="p">)</span>
    <span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">conf</span><span class="o">=</span><span class="n">conf</span><span class="p">)</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">spark</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Stop SparkSession app </span><span class="si">{</span><span class="n">app_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">spark</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>điều này giúp đơn giản hóa việc tạo sparksession và tắt spark trở nên đơn giản và tránh thiếu sót</p>
<div class="details admonition tip">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-lightbulb fa-fw"></i>Tip<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>Ta cũng có thể làm tương tự cho việc kết nối với mongodb bằng cách viết một <code>mongodb_io</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">MongoClient</span>
<span class="kn">from</span> <span class="nn">pymongo.errors</span> <span class="kn">import</span> <span class="n">ConnectionFailure</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">MongodbIO</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&#34;MONGODB_USER&#34;</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&#34;MONGODB_PASSWORD&#34;</span><span class="p">)</span>
    <span class="n">cluster</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&#34;MONGODB_SRV&#34;</span><span class="p">)</span>
    <span class="n">cluster</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;//&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;mongodb+srv://</span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">cluster</span><span class="si">}</span><span class="s2">/?retryWrites=true&amp;w=majority&#34;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;MongoDB Connected&#34;</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">client</span>
    <span class="k">except</span> <span class="n">ConnectionFailure</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Failed to connect with MongoDB&#34;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ConnectionFailure</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Close connection to MongoDB&#34;</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div></div>
        </div>
    </div>
<h3 id="data-processing" class="headerLink">
    <a href="#data-processing" class="header-mark"></a>Data Processing</h3><p>ta sẽ xây dựng hdfs theo kiến trúc meddalion bằng cách chia data quality thành cách vùng (hay directory):</p>
<ul>
<li><strong>Bronze layer</strong>: dùng để chỉ lưu raw data</li>
<li><strong>Silver layer</strong>: lưu data đã xử lý một phần (xử lý kiểu dữ liệu, xử lý kiểu array và các cấu trúc lồng phức tạp) từ Bronze Layer</li>
<li><strong>Gold layer</strong>: lưu data đã được làm sạch sau khi chuẩn hóa dữ liệu và làm sạch các bảng mới từ Silver Layer</li>
</ul>
<figure><img src="https://raw.githubusercontent.com/PhongHuynh0394/Spotify-Analysis-with-PySpark/refs/heads/main/image/pipeline2-a.jpg"/>
</figure>

<h2 id="analytic-layer" class="headerLink">
    <a href="#analytic-layer" class="header-mark"></a>Analytic layer</h2><p>Như đã setup từ trước, ta sẽ sử dụng dremio như một analytic layer để có thể phân tích trên data sạch ở gold layer trong HDFS. Việc đơn giản là ta chỉ cần kết nối dremio đến HDFS qua dremio UI ở <code>localhost:9047</code> và sau đó format file <code>.parquet</code> ở thư mục <code>gold_layer</code> và ta có thể viết các câu lệnh sql query để bắt đầu phân tích được rồi</p>
<figure><img src="https://raw.githubusercontent.com/PhongHuynh0394/Spotify-Analysis-with-PySpark/refs/heads/main/image/dremio.jpg"/>
</figure>

<h2 id="machine-learning-and-dashboard" class="headerLink">
    <a href="#machine-learning-and-dashboard" class="header-mark"></a>Machine learning and Dashboard</h2><p>Đến đây có thể coi như là kết thúc phần việc của một data engineer, ta sẽ bắt đầu các tasks của một data scientist và data analyst trong việc xây dựng mô hình máy học và xây dựng report.</p>
<h3 id="k-nearest-neighbors-knn" class="headerLink">
    <a href="#k-nearest-neighbors-knn" class="header-mark"></a>K-Nearest Neighbors (KNN)</h3><p>Ta sẽ xây dựng một mô hình có thể gợi ý nhạc dựa trên độ giống nhau giữa các features của những bản nhạc như: độ lớn, giai điệu, thể loại, tempo, mức độ sôi động,&hellip; Để làm được việc đó ta sẽ sử dụng một mô hình có thể đưa ra được top k các record khác nhau từ danh sách hàng trăm nghìn bài hát. Đó là <strong>KNN</strong></p>
<p>KNN là một mô hình học máy đơn giản giúp ta tìm được top những điểm data gần nhất với vị trí data point đầu vào dựa trên khoảng cách của chúng trong không gian vector. Similarity Metric lần này ta sử dụng sẽ là độ tương tự consine hay consine similarity</p>
<p>$$
S_C(A,B) = cos(\theta) = \frac{A \cdot B}{\Vert A\Vert \Vert B \Vert} = \frac{\sum^n_{i=1}A_iB_i}{\sqrt{\sum^n_{i=1}A^2} \cdot \sqrt{\sum^n_{i=1}B^2} }
$$</p>
<p>Ta sẽ xây dựng một mô hình gợi ý top k các bài hát giống nhất với bài hát lựa chọn như sau:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">SongRecommendationSystem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knn_model</span> <span class="o">=</span> <span class="n">NearestNeighbors</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>   
        <span class="n">matrix_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knn_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">matrix_table</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_get_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;select * from </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&#34;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">recommend_songs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">track_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;home.searchs&#39;</span><span class="p">,</span> <span class="n">num_recommendations</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">song_library</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">track_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">song_library</span><span class="p">[</span><span class="s1">&#39;track_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Track &#34;</span><span class="si">{</span><span class="n">track_name</span><span class="si">}</span><span class="s1">&#34; not found in the dataset.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
            
        <span class="n">features_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_table</span><span class="p">(</span><span class="s1">&#39;home.model&#39;</span><span class="p">)</span>
        <span class="n">track_index</span> <span class="o">=</span> <span class="n">song_library</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">song_library</span><span class="p">[</span><span class="s1">&#39;track_name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">track_name</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">knn_model</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">([</span><span class="n">features_matrix</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">track_index</span><span class="p">]],</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="n">num_recommendations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">song_library</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:],</span> <span class="p">:]</span>
</code></pre></td></tr></table>
</div>
</div><p>Khi thử tìm các bài hát giống với &ldquo;Something Just Like This&rdquo; (có vẻ cũng chưa tốt lắm 😂)
<figure><img src="https://i.imgur.com/WJAw1xZ.jpeg"/>
</figure>
</p>
<h3 id="powerbi-dashboard" class="headerLink">
    <a href="#powerbi-dashboard" class="header-mark"></a>PowerBI Dashboard</h3><p>Khi có rất nhiều data sạch, điều tiếp theo ta có thể nghĩ đến chính là làm sao thấy được nhiều insight giá trị nhất từ data đó. Đây là lúc ta có thể dùng PowerBI để xây dựng Dashboard từ Dremio</p>
<figure><img src="https://raw.githubusercontent.com/PhongHuynh0394/Spotify-Analysis-with-PySpark/refs/heads/main/image/powerbi-dash.jpg"/>
</figure>

<h2 id="application" class="headerLink">
    <a href="#application" class="header-mark"></a>Application</h2><p>Cuối cùng, ta có thể xây dựng một ứng dụng đơn giản để ứng dụng mô hình machine learning cũng như như tích hợp Dashboard vào trong ứng dụng này như một portal toàn diện. Ta sẽ sử dụng Streamlit để xây dựng một web app đơn giản</p>
<figure><img src="https://raw.githubusercontent.com/PhongHuynh0394/Spotify-Analysis-with-PySpark/refs/heads/main/image/ui.jpg"/>
</figure>

<h2 id="final-thoughts" class="headerLink">
    <a href="#final-thoughts" class="header-mark"></a>Final Thoughts</h2><p>Project chỉ mang tính chất học tập, do đó độ lớn của data hay một số kiến trúc set up có thể chưa hoàn chỉnh. Tuy nhiên đây vẫn là một cột mốc đáng nhớ trong hành trình học tập của OG. Hy vọng nó sẽ giúp ích cho các bạn tham khảo 😄</p>
<p><strong>-Meww-</strong></p>
<hr>
<h1 id="related" class="headerLink">
    <a href="#related" class="header-mark"></a>Related</h1>
<div class="showcase-box column-2">
    <div class="showcase-image">
        <a href=/stock_analysis/><img
        
        loading="lazy"
        src="/img/projects-stock.jpg"
        srcset="/img/projects-stock.jpg, /img/projects-stock.jpg 1.5x, /img/projects-stock.jpg 2x"
        sizes="auto"
        alt="Stock Analysis"
        title="Stock Analysis" height="200"   width="400" ></a>
    </div>
    <h2 class="showcase-title">
        <a href=/stock_analysis/>Stock Analysis</a>
    </h2>
    <p class="showcase-summary">
        Basic analyzing vn30 stock using pca and k-means
    </p>
    <a class="showcase-link" href=/stock_analysis/>
        Read more...
    </a>
</div>

<div class="showcase-box column-2">
    <div class="showcase-image">
        <a href=/football_etl/><img
        
        loading="lazy"
        src="/img/projects-football.jpg"
        srcset="/img/projects-football.jpg, /img/projects-football.jpg 1.5x, /img/projects-football.jpg 2x"
        sizes="auto"
        alt="Football ETL Analysis"
        title="Football ETL Analysis" height="200"   width="400" ></a>
    </div>
    <h2 class="showcase-title">
        <a href=/football_etl/>Football ETL Analysis</a>
    </h2>
    <p class="showcase-summary">
        A Data Engineer project building pipeline to analyze football data
    </p>
    <a class="showcase-link" href=/football_etl/>
        Read more...
    </a>
</div></div>

        <div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 10 Dec 2023</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share"><button title="Share on Facebook" data-sharer="facebook" data-url="https://phonghuynh.netlify.app/spotify_analysis/" data-hashtag="streamlit"><span class="fab fa-facebook-square fa-fw"></span></button><button title="Share on Linkedin" data-sharer="linkedin" data-url="https://phonghuynh.netlify.app/spotify_analysis/"><span class="fab fa-linkedin fa-fw"></span></button></div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/streamlit/">streamlit</a>,&nbsp;<a href="/tags/api/">API</a>,&nbsp;<a href="/tags/elt/">ELT</a>,&nbsp;<a href="/tags/data-engineer/">data engineer</a>,&nbsp;<a href="/tags/machine-learning/">Machine Learning</a>,&nbsp;<a href="/tags/distributed-system/">Distributed System</a>,&nbsp;<a href="/tags/hadoop/">Hadoop</a>,&nbsp;<a href="/tags/spark/">Spark</a>,&nbsp;<a href="/tags/docker/">docker</a>,&nbsp;<a href="/tags/terraform/">Terraform</a>,&nbsp;<a href="/tags/visualization/">Visualization</a>,&nbsp;<a href="/tags/powerbi/">PowerBI</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/spotify_analysis_en/" class="prev" rel="prev" title="Spotify Analysis"><i class="fas fa-angle-left fa-fw"></i>Spotify Analysis</a></div>
</div>
</article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2023 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank" rel="noopener noreferrer">OG</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
            <div class="footer-line"></div>
            <div class="footer-line">
            </div>
        </div></footer></div>

    <div id="fixed-buttons"><a href="#back-to-top" id="back-to-top-button" class="fixed-button" title="Back to Top">
            <i class="fas fa-arrow-up fa-fw"></i>
        </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
            <i class="fas fa-comment fa-fw"></i>
        </a>
    </div><div class="assets"><link rel="stylesheet" href="/lib/lightgallery/lightgallery.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/katex/copy-tex.min.css">
        <noscript><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"></noscript><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"distance":100,"findAllMatches":false,"fuseIndexURL":"/index.json","highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":false,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"No results found","snippetLength":30,"threshold":0.3,"type":"fuse","useExtendedSearch":false},"sharerjs":true,"table":{"sort":true}};</script><script type="text/javascript" src="/lib/tablesort/tablesort.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lightgallery.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-thumbnail.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-zoom.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js" defer></script><script type="text/javascript" src="/lib/katex/auto-render.min.js" defer></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js" defer></script><script type="text/javascript" src="/lib/katex/mhchem.min.js" defer></script><script type="text/javascript" src="/js/katex.min.js" defer></script><script type="text/javascript" src="/js/theme.min.js" defer></script></div>
</body>

</html>